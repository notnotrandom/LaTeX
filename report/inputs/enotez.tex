% --- Setup enotez package ---

% This version of the enotez setup works for appendices, but NOT for endnotes
% within starred chapters. In fact, until one has a final draft, in these
% chapters one should the \fn command to produce footnotes. For details how to
% setup endnotez for starred chapters once one does have a final draft, see
% https://randomwalk.eu/LaTeX/enotez-starred-and-appendix.

% To detect if a given (non-starred) chapter is, or not, an appendix.
\newif\ifinappendix% Default is \inappendixfalse

% Use endnotes for regular chapters, and footnotes for appendix. Also,
% \footnote{text} produces a footnote, using a symbol, to avoid confusion with
% endnotes.
\let\oldappendix\appendix% Store \appendix
\renewcommand{\appendix}{% Update \appendix
  \oldappendix% Default \appendix
  \inappendixtrue% Set switch to true
}

% For use in starred chapters.
% Make footnotes use symbols, and have no hyperlinks.
\renewcommand*{\thefootnote}{\fnsymbol{footnote}}
\newcommand\fn[1]{%
  \begin{NoHyper}%
    \footnote{#1}%
  \end{NoHyper}%
}

\setenotez{
  backref=true,
  totoc=chapter,
  counter-format=arabic,
  reset=true,
  split=chapter,
  split-title={<ref>. <title>}
}

% Grab the correct title, even for appendices.
\NewSplitTitleTag{title}{%
  \ifnum0<0<ref>\relax%
    \nameref*{ch:<split-level-id>}%
  \else%
    \nameref*{appdx:<ref>}%
  \fi%
}

% Requires package letltxmacro. Create a counter for numbered chapters, to be
% able to show chapter names in Notes' listing. The label is different for
% appendices, because for the these, the chapter counter is reset (if the label
% was the same, then chapter 1 and appendix A would have the same label, etc.).
\LetLtxMacro\origchapter\chapter
\RenewDocumentCommand\chapter{som}{%
  \IfBooleanTF{#1}
    {% starred chapter, no label then
      \origchapter*{#3}%
    }
    {% else add a label
      \IfNoValueTF{#2}
        {\origchapter{#3}}
        {\origchapter[#2]{#3}}%
        \ifinappendix%
          \expanded{\noexpand\label{appdx:\thechapter}}%
        \else%
          \expanded{\noexpand\label{ch:\thechapter}}%
        \fi%
    }%
}

% This is needed before setting up fancyhdr, to get the page header right in
% the Notes' chapter (this is only relevant when said chapter has more than one
% page...)
\setenotez{list-heading=\chapter*{#1\markboth{#1}{}}}

% Left-align start of note with the respective chapter heading.
\DeclareInstance{enotez-list}{plain}{paragraph}{format=\footnotesize\leftskip1.25em}
